\documentclass[a4paper, 10pt, twocolumn, twoside]{book}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%
%% ShadowTeXSR5.cls
%%
%% Author: Tobias Braun
%% Jan, 2020
%%
%% ALL FONTS USED ARE LICENSED FOR NON-COMMERCIAL PURPOSES ONLY
%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\makeatletter
%%%%%%%%%%%%%%%%%%%%
%%
%% PACKAGES
%%
%%%%%%%%%%%%%%%%%%%%

\usepackage{stfloats}
\usepackage{lmodern}
\usepackage[dvipdfx, rgb, table]{xcolor}
\usepackage{graphicx}
\usepackage{hyphenat}
\usepackage[11pt]{moresize}
\usepackage{etoolbox}
\usepackage{multicol}
%\usepackage{ifthen}
\usepackage{xifthen}
%\PassOptionToPackage{hidelinks}{hyperref}
\usepackage[hidelinks]{hyperref}
\usepackage{tikz}
  \usetikzlibrary{fadings}
  \usetikzlibrary{patterns}
  \usetikzlibrary{calc}
\usepackage{array}
\usepackage{tabularx}
\usepackage{booktabs}
\usepackage{environ}
\usepackage{enumitem}


%%%%%%%%%%%%%%%%%%%%
%%
%% CORE CHANGES
%%
%%%%%%%%%%%%%%%%%%%%

%Restrict placement of single-column floats to outer columns only.
%(experimental)
\def\@floatplacement{
  \def\zero{0}
  %Textpage bit, global:
  \ifodd\c@page
    \if@firstcolumn
      \global\@topnum \zero
      \global\@botnum \zero
    \else
      \global\@topnum \c@topnumber 
      \global\@botnum \c@bottomnumber
    \fi
  \else
    \if@firstcolumn
      \global\@topnum \c@topnumber 
      \global\@botnum \c@bottomnumber
    \else
      \global\@topnum \zero
      \global\@botnum \zero
    \fi
  \fi
  \global\@colnum  \c@totalnumber
  \global\@toproom \topfraction\@colht
  \global\@botroom \bottomfraction\@colht
  % Floatpage bit, local:
  \@fpmin   \floatpagefraction\@colht
}

%Change \cleardoublepage so that new chapters begin on even sides
%instead of odd.
\renewcommand*\cleardoublepage{
  \clearpage
  \if@twoside
    \ifodd\c@page 
      \ifnum\c@page=1\else      
        \hbox{}\newpage
        \if@twocolumn
          \hbox{}%
          \newpage
        \fi
      \fi
    \fi
  \fi
}

%Two-Column TOC, extracted and adapted for starred version from multitoc package.

\newboolean{@multitoc@toc}
\newboolean{@multitoc@lot}
\newboolean{@multitoc@lof}

\setboolean{@multitoc@toc}{true}
\setboolean{@multitoc@lot}{false}
\setboolean{@multitoc@lof}{false}

\let\@multitoc@starttoc\@starttoc
\renewcommand*{\@starttoc}[1]{%
  \ifthenelse{\boolean{@multitoc@toc}\and\equal{#1}{toc}}{%
    \begin{multicols*}{2}%
      \@multitoc@starttoc{#1}%
    \end{multicols*}%
  }{}%
  \ifthenelse{\boolean{@multitoc@lot}\and\equal{#1}{lot}}{%
    \begin{multicols*}{2}%
      \@multitoc@starttoc{#1}%
    \end{multicols*}%
  }{}%
  \ifthenelse{\boolean{@multitoc@lof}\and\equal{#1}{lof}}{%
    \begin{multicols*}{2}%
      \@multitoc@starttoc{#1}%
    \end{multicols*}%
  }{}%
}


%%%%%%%%%%%%%%%%%%%%
%%
%% NEW VALUES
%%
%%%%%%%%%%%%%%%%%%%%

\newif\ifTitleSpread
\def\sr@coverartist{}
\def\sr@writers{}
\def\sr@artists{}
\def\srbb@mainauthor{}
\def\srbb@texts{}
\def\srbb@cover{}
\def\srbb@illustrations{}

%%%%%%%%%%%%%%%%%%%%
%%
%% NEW COMMANDS
%%
%%%%%%%%%%%%%%%%%%%%

\newcommand\styleB{\rightskip=0pt plus .8\hsize\relax \parfillskip=0pt plus-.7\hsize\relax}

\newcommand{\splashpicture}[1]{
  \def\tmp{#1}  
  \let\srsplash\tmp
  \pgfdeclareimage[width=\paperwidth, height=\paperheight]{splashimage}{./images/\tmp}
}

\newcommand*{\belowrulesepcolor}[1]{%
  \noalign{%
    \kern-\belowrulesep
    \begingroup
      \color{#1}%
      \hrule height\belowrulesep
    \endgroup
  }%
}
\newcommand*{\aboverulesepcolor}[1]{%
  \noalign{%
    \begingroup
      \color{#1}%
      \hrule height\aboverulesep
    \endgroup
    \kern-\aboverulesep
  }%
}

%%%%%%%%%%%%%%%%%%%%
%%
%% BASIC PAGE SETUP
%%
%%%%%%%%%%%%%%%%%%%%

%%%%%%%%%%%%%%%%%
%% COLORS
%%%

\definecolor{yellowtext}{HTML}{f9b00b}
\definecolor{redtext}{HTML}{931004}
\definecolor{whitetext}{gray}{0.5}
  
\definecolor{normalpage}{gray}{0.95}
\definecolor{storyblack}{gray}{0.1}
\definecolor{boxred}{HTML}{721a16}
\definecolor{headred}{HTML}{5e1519}
  
\newcommand{\globalcolor}[1]{%
  \color{#1}\global\let\default@color\current@color
}

%%%%%%%%%%%%%%%%%
%% FONTS
%%%

\usepackage{fontspec}

\newfontfamily{\bodyfont}[
  Path = ./core/fonts/,
  Extension = .ttf,
  UprightFont = *-rg,
  BoldFont = *-b,
  ItalicFont = *-i,
  BoldItalicFont = *-bi,
  NFSSFamily = srbody
]{srfont}
\newfontfamily{\deckerfont}[
  Path = ./core/fonts/,
  Extension = .ttf,  
  UprightFont = *-rg,
  BoldFont = *-b
]{dckr}
\newfontfamily{\headerfont}[
  Path = ./core/fonts/,
  Extension = .ttf,
  UprightFont = *-rg,  
]{sublm}
\newfontfamily{\boxfont}[
  Path = ./core/fonts/,
  Extension = .ttf,
  UprightFont = *-rg  
]{universcondensed}
  
\renewcommand{\rmdefault}{srbody}
\renewcommand{\sfdefault}{srbody}

%%%%%%%%%%%%%%%%%
%% GRAPHICS
%%%

\usepackage{pgf} 

\pgfdeclareimage{cover-black}{./core/tikz/Cover-black.pdf}
\pgfdeclareimage{cover-red}{./core/tikz/Cover-red.pdf}
\pgfdeclareimage{cover-blue}{./core/tikz/Cover-blue.pdf}
\pgfdeclareimage{cover-green}{./core/tikz/Cover-green.pdf}
\pgfdeclareimage{cover-yellow}{./core/tikz/Cover-yellow.pdf}
\pgfdeclareimage{cover-brown}{./core/tikz/Cover-brown.pdf}
\pgfdeclareimage{cover-grey}{./core/tikz/Cover-grey.pdf}

\pgfdeclareimage{leftfooter}{./core/tikz/FooterLeft.pdf}
\pgfdeclareimage{rightfooter}{./core/tikz/FooterRight.pdf}
\pgfdeclareimage{leftfootersimple}{./core/tikz/SimpleFooterLeft.pdf}
\pgfdeclareimage{rightfootersimple}{./core/tikz/SimpleFooterRight.pdf}

\pgfdeclareimage{bigleftheader}{./core/tikz/HeaderLeftBig.pdf}
\pgfdeclareimage{bigrightheader}{./core/tikz/HeaderRightBig.pdf}
\pgfdeclareimage{smallleftheader}{./core/tikz/HeaderLeftSmall.pdf}
\pgfdeclareimage{smallrightheader}{./core/tikz/HeaderRightSmall.pdf}

\pgfdeclareimage{widepictureframe}{./core/tikz/Twocolumnframe.pdf}
\pgfdeclareimage[width=\paperwidth, height=.98\paperheight]{longpictureframe}{./core/tikz/Columnframe.pdf}

%%%%%%%%%%%%%%%%%
%% GEOMETRY
%%%

\usepackage{geometry}

\geometry{a4paper, 
  includeheadfoot,
  top=0cm, 
  headheight=23mm, 
  headsep=7mm, 
  footskip=23mm, 
  bottom=7mm,
  left=20mm, 
  right=15mm
} 

%%%%%%%%%%%%%%%%%
%% BACKGROUND
%%%

\usepackage[pagecolor=normalpage]{pagecolor}
\usepackage{background}

\backgroundsetup{
  scale=1,
  opacity=.01,
  angle=0,
  contents={%
    \includegraphics[width=\paperwidth , height=\paperheight]{core/images/scanlines.png}
  }
}

%%%%%%%%%%%%%%%%%
%% PENALTIES
%%%

\widowpenalty10000
\clubpenalty10000

%%%%%%%%%%%%%%%%%%%%
%%
%% TABLE OF CONTENTS
%%
%%%%%%%%%%%%%%%%%%%%

\usepackage{tocloft}
\usepackage{titlesec}

\patchcmd{\l@chapter}
  {\cftchapfont #1}%   search pattern
  {\texorpdfstring{\cftchapfont\uppercase{#1}}{#1}}% replace by
  {}%                  success
  {}%                  failure

\setcounter{tocdepth}{3}

\renewcommand{\cfttoctitlefont}{\color{redtext}\headerfont\Huge\MakeUppercase}
\renewcommand{\cftaftertoctitle}{\\[-0.75em]\color{redtext}\titlerule}

\setlength{\cftchapnumwidth}{0pt}
\setlength{\cftsecnumwidth}{0pt}
\setlength{\cftsubsecnumwidth}{0pt}
\setlength{\cftsubsubsecnumwidth}{0pt}

%Dots
\renewcommand{\cftdot}{.}
\renewcommand{\cftdotsep}{0.1}
\renewcommand{\cftchapdotsep}{0.1}

%Indents
\renewcommand{\cftchapindent}{0em}
\renewcommand{\cftsecindent}{0em}
\renewcommand{\cftsubsecindent}{1em}
\renewcommand{\cftsubsubsecindent}{2em}

%Fonts
\renewcommand{\cftchapfont}{\boxfont\color{redtext}\bfseries}
\renewcommand{\cftchappagefont}{\boxfont\color{redtext}\bfseries}

\renewcommand{\cftsecfont}{\boxfont\color{redtext}\small\bfseries}
\renewcommand{\cftsecpagefont}{\boxfont\color{redtext}\small\bfseries}

\renewcommand{\cftsubsecfont}{\boxfont\small}
\renewcommand{\cftsubsecpagefont}{\boxfont\small}

\renewcommand{\cftsubsubsecfont}{\boxfont\small}
\renewcommand{\cftsubsubsecpagefont}{\boxfont\small}

%Leaders
\renewcommand{\cftchapleader}{\color{redtext}\cftdotfill{\cftsecdotsep}}
\renewcommand{\cftsecleader}{\color{redtext}\cftdotfill{\cftsecdotsep}}
\renewcommand{\cftsubsecleader}{\cftdotfill{\cftsecdotsep}}
\renewcommand{\cftsubsubsecleader}{\cftdotfill{\cftsecdotsep}}

%%%%%%%%%%%%%%%%%%%%
%%
%% PAGESTYLES/HEADER AND FOOTER
%%
%%%%%%%%%%%%%%%%%%%%
\graphicspath{{./images/}}
\usepackage{fancyhdr}

\renewcommand{\headrulewidth}{0pt}

%%%%%%%%%%%%%%%%%
%% FOOTERS
%%%

\newcommand{\footerleft}[1]{
\begin{tikzpicture}[remember picture, overlay, shift={(current page.south west)}]
	\node[anchor=center] at (.5\paperwidth,.5\paperheight) {\pgfuseimage{#1}};
	\node [anchor=west, white, font=\headerfont] at (27mm,9mm) {\LARGE\thepage\hspace{1cm}\Large\leftmark\hspace{1em}\Huge\guillemotright};
	\end{tikzpicture}	
}

\newcommand{\footerright}[1]{
	\begin{tikzpicture}[remember picture, overlay, shift={(current page.south west)}]
	\node[anchor=center] at (.5\paperwidth,.5\paperheight) {\pgfuseimage{#1}};
	\node [anchor=east, align=right, white, font=\headerfont] at (\paperwidth-27mm,9mm) {\Huge\guillemotleft\hspace{1em}\Large\leftmark\hspace{1cm}\LARGE\thepage};
	\end{tikzpicture}	

}

%%%%%%%%%%%%%%%%%
%% PLAIN
%%%

\fancypagestyle{plain}{
  \fancyhf{}	
  \fancyhead[LE]{
    \begin{tikzpicture}[remember picture, overlay, shift={(current page.center)}]
	  \ifTitleSpread
	    \suppressfloats[t]
	    \suppressfloats[b]	  
	    \node at (0,0) {\pgfuseimage{bigleftheader}};
	    \node[anchor=south west, fill=redtext, minimum height=6mm, white, font=\headerfont] at (-.5\paperwidth+15mm,.5\paperheight-14mm) {\MakeUppercase{\doctitle}};
	    \draw node[anchor=west, white, align=left, font=\headerfont\fontsize{60}{50}\selectfont] at (-.5\paperwidth+8mm,{(.5\paperheight)-(.5\headheight)})
 {\parbox{183mm}{\styleB \nohyphens{\MakeUppercase{\leftmark}}}};
      \else
        \node at (0,0) {\pgfuseimage{smallleftheader}};	  
	    \node[anchor=west, white, font=\headerfont] at (-.5\paperwidth+15mm,{(.5\paperheight)-((.5\headheight)-2mm)}) {\Large\guillemotright~~\normalsize\doctitle~~\Large\guillemotleft};
	  \fi	  
	\end{tikzpicture}
  }
  \fancyhead[LO]{
    \begin{tikzpicture}[remember picture, overlay, shift={(current page.center)}]
      \ifTitleSpread
        \suppressfloats[t]
        \suppressfloats[b]
        \node at (0,0) {\pgfuseimage{bigrightheader}};
        \@ifundefined{srsplash}{}{
          \begin{scope}
            \clip(-.5\paperwidth,.5\paperheight) rectangle (.5\paperwidth,{.5\paperheight-(\headheight-3mm)});
            \node[red, anchor=center, opacity=0.25] at (0,.5\paperheight) {\pgfuseimage{splashimage}};
          \end{scope}
        } 
	  \else
        \node at (0,0) {\pgfuseimage{smallrightheader}};
        \@ifundefined{srsplash}{}{
          \begin{scope}
            \clip(-.5\paperwidth,.5\paperheight) rectangle (.5\paperwidth,{.5\paperheight-(\headheight-3mm)});
            \node[red, anchor=center, opacity=0.25] at (0,.5\paperheight) {\includegraphics[height=\paperheight, width=\paperwidth]{\srsplash}};
	      \end{scope}
        } 
        \node[anchor=east, align=left, white, font=\headerfont] at (.5\paperwidth-15mm,{(.5\paperheight)-((.5\headheight)-2mm)}) {\large\guillemotright~~\normalsize\doctitle~~\Large\guillemotleft};
	  \fi
    \end{tikzpicture}
    \global\headheight=23mm
    \global\textheight=237mm
    \global\TitleSpreadfalse
  }
  \fancyfoot[LE]{
    \footerleft{leftfooter}
  }
  \fancyfoot[LO]{
    \footerright{rightfooter}
    \global\headsep=7mm
  }  
}

%%%%%%%%%%%%%%%%%
%% STORY
%%%

\fancypagestyle{story}{
  \fancyhf{}
  \fancyhead[LE]{
    \suppressfloats[t]
    \suppressfloats[b]
    \ifTitleSpread  
      \begin{tikzpicture}[remember picture, overlay]
        \node at (.5\paperwidth-15mm,.5\headheight) {\includegraphics[width=\paperwidth, height=\headheight]{\storyleftimage}};
        \fill[fill=redtext, path fading=east, fill opacity=.8] (-15mm,0) rectangle (\paperwidth, 3);
        \draw node[white, align=justify, font=\headerfont\fontsize{40}{35}\selectfont\styleB] at (65mm,15mm) {\parbox{140mm}{\styleB \nohyphens{\MakeUppercase{\leftmark}}}};
      \end{tikzpicture}
    \fi
  }
  \fancyhead[LO]{
    \suppressfloats[t]
    \suppressfloats[b]  
    \ifTitleSpread
      \begin{tikzpicture}[remember picture, overlay]
        \node at (.5\paperwidth-20mm,.5\headheight) {\includegraphics[width=\paperwidth, height=\headheight]{\storyrightimage}};
        \fill[anchor=south east, fill=redtext, path fading=west, fill opacity=.8] (.4\paperwidth,0) rectangle (\paperwidth-20mm, 10mm);
        \draw node[white, anchor=east, font=\headerfont\large] at (\paperwidth-40mm, 0.5) {\MakeUppercase{\storyauthor}};
      \end{tikzpicture}
    \fi
    \global\headheight=23mm
    \global\textheight=237mm
	\global\TitleSpreadfalse
  }
  \fancyfoot[LE]{
    \footerleft{leftfootersimple}
  }
  \fancyfoot[LO]{
    \footerright{rightfootersimple}
    \global\headsep=7mm
  }  
}

\pagestyle{plain}

%%%%%%%%%%%%%%%%%%%%
%%
%% CHAPTERS AND SECTIONS
%%
%%%%%%%%%%%%%%%%%%%%

\renewcommand{\chaptermark}[1]{ \markboth{#1}{} }
\renewcommand{\chaptername}{}
\renewcommand{\thechapter}{}
\renewcommand{\thesection}{}
\renewcommand{\thesubsection}{}

\titleformat{\section}
  {\headerfont\huge\color{redtext}\raggedright\nohyphens}{}{0cm}{\MakeUppercase}[{\color{redtext}\nobreak\titlerule}]

\titleformat{\subsection}
  {\headerfont\Large\color{redtext}\raggedright\nohyphens}{}{0cm}{\MakeUppercase}[{\color{redtext}\nobreak\titlerule}]
  
\titleformat{\subsubsection}
  {\headerfont\large\raggedright\nohyphens}{}{0cm}{\MakeUppercase}[{\color{black}\nobreak\titlerule}]

%%%%%%%%%%%%%%%
%% NEW CHAPTER DEFS
%%%

\newcommand{\storychapter}[4]{
  \def\tmp{#2}
  \let\storyauthor\tmp
  \def\tmp{#3}
  \let\storyleftimage\tmp
  \def\tmp{#4}  
  \let\storyrightimage\tmp
  \stchapter{#1}
}

\newcommand{\stchapter}{
  \cleardoublepage
  \phantomsection
  \global\TitleSpreadtrue
  \newpagecolor{storyblack}
  \globalcolor{white}
  \pagestyle{story}
  \newgeometry{ 
    includeheadfoot,
    top=0cm, 
    bottom=7mm,
    headheight=15cm, 
    headsep=5mm, 
    footskip=23mm, 
    left=20mm, 
    right=15mm
  }
  \global\@topnum\z@
  \@afterindentfalse
  \secdef\@chapter\@schapter
}

\renewcommand\chapter{
  \cleardoublepage  
  \phantomsection
  \global\TitleSpreadtrue
  \restorepagecolor
  \globalcolor{black}
  \pagestyle{plain}
  \newgeometry{ 
    includeheadfoot,
    top=0cm, 
    bottom=7mm,
    headheight=73mm, 
    headsep=10mm, 
    footskip=23mm, 
    left=20mm, 
    right=15mm
  }
  \global\@topnum\z@
  \@afterindentfalse
  \secdef\@chapter\@schapter
}
                    
\def\@chapter[#1]#2{
  \ifnum \c@secnumdepth >\m@ne
    \if@mainmatter
      \refstepcounter{chapter}%
      \typeout{\@chapapp\space\thechapter.}%
      \addcontentsline{toc}{chapter}%
      {\protect\numberline{\thechapter}#1}%
    \else
      \addcontentsline{toc}{chapter}{#1}%
    \fi
  \else
    \addcontentsline{toc}{chapter}{#1}%
  \fi
  \chaptermark{#1}%
  \addtocontents{lof}{\protect\addvspace{10\p@}}%
  \addtocontents{lot}{\protect\addvspace{10\p@}}%
}

\def\@schapter#1{}

%%%%%%%%%%%%%%%%%%%%
%%
%% NEW ELEMENTS
%%
%%%%%%%%%%%%%%%%%%%%

\usepackage[many]{tcolorbox}

%%%%%%%%%%%%%%%%%%%
%% IMAGES
%%%
\newcommand{\twocolumnimage}[1]{
  \begin{figure*}[t]
  \centering
  \vspace*{13cm}
  \begin{tikzpicture}[remember picture, overlay, shift={(current page.north)}]
  \node[anchor=north] at (0,{-(30mm)}) {\includegraphics[width=\textwidth, height=12cm]{#1}};
  \node[anchor=north] at (0,{-((30mm)-(8.85cm))}) {\pgfuseimage{widepictureframe}};
  \end{tikzpicture}
  \end{figure*}
}

\usepackage{afterpage}

\newcommand{\drawcolimg}[1]{

  \iftopfloat{
  \afterpage{\lp@columnimage{#1}}
  }{
  \begin{tcolorbox}[
    enhanced,
    width=\columnwidth,
    top=0mm,
    bottom=0mm,	
    left=0mm,
    right=0mm,    
    opacityframe=1,
    opacityback=1,
    colframe=storyblack,
    coltext=white,
    interior style={fill stretch image=#1, fill image opacity=1},
    interior code app={\node[anchor=center] at (frame.center) {\pgfuseimage{longpictureframe}};},
  ]
  \vspace*{231mm}
  \end{tcolorbox}
  }
}

\newcommand{\lp@columnimage}[1]{
  \ifodd\c@page
      \afterpage{\drawcolimg{#1}}	
  \else
	  \drawcolimg{#1}
  \fi
}

\newcommand{\columnimage}[1]{
  \ifodd\c@page
      \afterpage{\drawcolimg{#1}}	
  \else
	\if@firstcolumn
	  \afterpage{\afterpage{\afterpage{\drawcolimg{#1}}}}
	\else
	  \afterpage{\afterpage{\drawcolimg{#1}}}
	\fi  
  \fi
}

%%%%%%%%%%%%%%%%%%%%
%% BOXES
%%%

\newenvironment{twocolumnblackbox}[1]{
\begin{tcolorbox}[enhanced, fonttitle=\boxfont, float*, colback=storyblack, left=2mm, right=2mm, bottom=6mm, top=3mm, title={\color{yellowtext}\Large\MakeUppercase{#1}}, width = \textwidth, arc=0mm, outer arc=0mm, colframe=storyblack, attach boxed title to top left={yshift=-1mm}, boxed title style={arc=0mm, top=2mm, bottom=1mm, colframe=storyblack, colback=storyblack, outer arc=0mm}, underlay boxed title={\fill[storyblack] ($(title.north east)+(-2mm, 0mm)$) -- ($(title.south east)+(-2mm, 0mm)$) -- ($(title.south east)+(2mm, 0mm)$) -- ++(2cm, 0mm) -- ($(title.north east)+(2mm, 0mm)$) -- cycle;}]
\centering
}{\end{tcolorbox}}

\newcommand{\sr@lbox}[1]{
  \begin{tcolorbox}[
	enhanced,	
	before={\hspace{-32mm}},
	top=4mm,
    bottom=4mm,	
	left=25mm,
	right=5mm,    
    opacityframe=1,
    opacityback=1,
    interior style={left color=boxred,right color=redtext},
    colframe=storyblack,
    coltext=white,
    text width=\dimexpr\columnwidth-7mm,
    boxrule=2mm,
    arc is angular,    
    arc=6mm,outer arc=7mm
    ]
    #1
    \end{tcolorbox}
}

\newcommand{\sr@rbox}[1]{
  \begin{tcolorbox}[
	enhanced,
    top=4mm,
    bottom=4mm,	
	left=5mm,
    right=25mm,
	opacityframe=1,
    opacityback=1,
    interior style={left color=redtext,right color=boxred},
    colframe=storyblack,
    coltext=white,
    text width=\dimexpr\columnwidth-7mm,
    boxrule=2mm,
  	arc is angular,    
    arc=6mm,outer arc=7mm]
    #1
    \end{tcolorbox}
}

\NewEnviron{columnbox}[1][]{
  \hfuzz=20mm
  \par
  \boxfont
  \ifthenelse{\isempty{#1}}%
    {\if@firstcolumn
      \sr@lbox{\BODY}
    \else
      \sr@rbox{\BODY}
    \fi
  }% if #1 is empty
  {
    \ifthenelse{\equal{#1}{l}}{\sr@lbox{\BODY}}{\sr@rbox{\BODY}}
  }%
}

\newenvironment{twocolumnbox}{
\boxfont
\ifodd\c@page
  \begin{tcolorbox}[
	enhanced,
	top=4mm,
    bottom=4mm,	
	left=25mm,
	right=5mm,    
    opacityframe=1,
    opacityback=1,
    interior style={left color=boxred,right color=redtext, fill plain image=./core/images/scanlines.png, fill image opacity=0.1},
    colframe=storyblack,
    coltext=white,
    text width=\textwidth-7mm,
    boxrule=2mm,
    arc is angular,    
    arc=6mm,outer arc=7mm,
    float*=h!tb,
    every float=\hspace{-32mm}
    ] 
\else
   \begin{tcolorbox}[
	enhanced,
	top=4mm,
    bottom=4mm,	
	left=5mm,
	right=25mm,    
    opacityframe=1,
    opacityback=1,
    interior style={left color=redtext,right color=boxred, fill plain image=./core/images/scanlines.png, fill image opacity=0.1},
    colframe=storyblack,
    coltext=white,
    text width=\textwidth-7mm,
    boxrule=2mm,
    arc is angular,    
    arc=6mm,outer arc=7mm,
    float*=h!tb
    ]
\fi
}{\end{tcolorbox}}

%%%%%%%%%%%%%%%%%%%%
%% TABLES
%%%

\NewEnviron{srtable}[2]{
  \rowcolors{1}{\ifnumless{\rownum}{2}{black}{storyblack}}{storyblack!80!white}  
  \arrayrulecolor{yellowtext}
  \color{white}\small
  \begin{tabularx}{\textwidth}{#1}
  \toprule
  \belowrulesepcolor{black}
  #2\\
  \aboverulesepcolor{black}   
  \bottomrule
  \BODY
  \toprule
  \end{tabularx}
}

%%%%%%%%%%%%%%%%%%%
%% OTHER AREAS
%%%

\NewEnviron{dckcomment}[1]{
  \def\commentauthor{#1}
  \setmainfont{Decker}
  \small
  \par
  \begin{itemize}[
  leftmargin=1.2em, 
  itemsep=-1ex,
  label={\begin{tcolorbox}[valign=center, halign=center,hbox,boxsep=-3.7mm, boxrule=0mm,colback=black, square, circular arc] {\color{normalpage}\bfseries\textgreater}	\end{tcolorbox}}
  ]
  \item \BODY \\
  \item #1
  \end{itemize}
  \par
}


%%%%%%%%%%%%%%%%%%%%
%%
%% NEW COMMANDS II
%%
%%%%%%%%%%%%%%%%%%%%



\newcommand{\srmaketitle}[1][black]{
  \def\coverframe{cover-}
  \g@addto@macro\coverframe{#1}
  \let\doctitle\@title 
  \pagestyle{empty}
  \cleardoublepage
  \begin{titlepage}
    \hfuzz=100pt
    \@ifundefined{srsplash}{
      \begin{center}
        {\Huge\headerfont\color{redtext}\@title}\\
        {\Large\headerfont\color{redtext}\@author}
      \end{center}
      \end{titlepage}
    }{
      \begin{tikzpicture}[remember picture, overlay, shift={(current page.center)}]
        \node[opacity=1, inner sep=0pt, scale=0.9] at (0,-30mm) {\pgfuseimage{splashimage}};
        \node[opacity=1, inner sep=0pt] at (0,0) {\pgfuseimage{\coverframe}};
      \end{tikzpicture}
      \end{titlepage}
      \newpage
      \makeimpressum
      \newpage
      \mainmatter
      \tikz[remember picture,overlay] \node[opacity=1,inner sep=0pt] at (current page.center){\pgfuseimage{splashimage}};
    }

  %\setcounter{page}{2}
  \cleardoublepage
  \pagestyle{plain}
}

\newcommand{\makeimpressum}{
  \vspace*{.6\textheight}
  \begin{tcolorbox}[
    enhanced,
    before=\hspace{-25mm},
    top=4mm,
    bottom=4mm,	
    left=25mm,
    right=25mm,    
    opacityframe=1,
    opacityback=1,
    colback=boxred,
    interior style={fill plain image=./core/images/scanlines.png, fill image opacity=0.1},
    colframe=storyblack,
    coltext=white,
    text width=\textwidth-7mm,
    boxrule=2mm
  ]
  \begin{multicols*}{2}[{\color{yellowtext}\Huge Impressum}]
  \color{white}\normalsize
    
  \textbf{\srbb@mainauthor:} \@author\\
  \textbf{\srbb@texts:} \sr@writers\\
  \textbf{\srbb@cover:} \sr@coverartist\\
  \textbf{\srbb@illustrations:} \sr@artists
  \end{multicols*}
  \begin{center}
  {\bfseries This template was created for hobbyists and is NOT to be used for commercial purposes.}  
  \par
    The Topps Company, Inc. has sole ownership of the names, logo, artwork, marks, photographs, sounds, audio, video and/or any proprietary material used in connection with the game Shadowrun. The Topps Company, Inc. has granted permission to \@author ~to use such names, logos, artwork, marks and/or any proprietary materials for promotional and informational purposes on its website but does not endorse, and is not affiliated with \@author ~in any official capacity whatsoever.
    \par
    Shadowrun-Logo und Inhalte mit freundlicher Genehmigung von Pegasus Spiele unter Lizenz von Catalyst Game Labs und Topps Company, Inc. © 2014 Toppy Company, Inc. Alle Rechte vorbehalten. Shadowrun ist eine eingetragene Handelsmarke von Topps Company, Inc.
  \end{center}
\end{tcolorbox}
}

\newcommand{\storypar}{
  \begin{center}
  \resizebox{3mm}{!}{$\textcolor{redtext}\ast$}
  \end{center}
}

\newcommand{\artists}[1]{
\def\sr@artists{#1}
}

\newcommand{\coverartist}[1]{
\def\sr@coverartist{#1}
}

\newcommand{\writers}[1]{
\def\sr@writers{#1}
}

%%%%%%%%%%%%%%%%%%%%
%%
%% SOLITARY PACKAGES II
%%
%%%%%%%%%%%%%%%%%%%%

%%%%%%%%%%%%%%%%%%%%
%%
%% TERMINOLOGY
%%
%%%%%%%%%%%%%%%%%%%%

\PassOptionsToPackage{english}{babel}
\PassOptionsToPackage{ngerman}{babel}

\usepackage{babel}

\addto\captionsenglish{% Replace "english" with the language you use
  \renewcommand{\contentsname}{Content}%
  \renewcommand{\srbb@mainauthor}{Main Author}
  \renewcommand{\srbb@cover}{Cover Image}
  \renewcommand{\srbb@illustrations}{Illustrations \& Maps}
  \renewcommand{\srbb@texts}{Texts}
}

\addto\captionsngerman{
  \renewcommand{\contentsname}{Inhalt}
  \renewcommand{\srbb@mainauthor}{Hauptautor}
  \renewcommand{\srbb@cover}{Coverbild}
  \renewcommand{\srbb@illustrations}{Illustrationen \& Karten}
  \renewcommand{\srbb@texts}{Texte}
}


\graphicspath{{./images/}}
\makeatother
\frontmatter
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%
%% .TEX FILE START
%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%To Be Removed
\usepackage{lipsum}

\selectlanguage{ngerman}

\title{My Rulebook}
\author{Me}
\artists{Me, Myself \& I}
\coverartist{Me, too}
\writers{Not me}
\splashpicture{Shadowrun_Cover_1530x1980px.jpg}

\begin{document}
\srmaketitle
\tableofcontents

\chapter{This is a Chapter}
\lipsum
\lipsum
\section{This is a Section}
\lipsum[1]
\subsection{This is a Subsection}
\lipsum
\subsubsection{This is a Subsubsection}
\lipsum
\chapter{Boxes}
\lipsum
\lipsum
\section{ColumnBox}
\lipsum[1]
\begin{columnbox}[l]
\lipsum[1]
\end{columnbox}
\section{TwoColumnBox}
\lipsum
\begin{twocolumnbox}
\centering\Huge Yay!\\
\normalsize\lipsum[1-3]
\end{twocolumnbox}
\lipsum
\lipsum
\lipsum
\lipsum
\section{BlackBox}
\lipsum
\begin{twocolumnblackbox}{Titel}
\centering\color{white}
\lipsum[1]
\begin{srtable}{Xc}{Values & Dangers}
Value & Danger\\
Value2 & Danger2\\
Rick & Morty\\
\end{srtable}
\end{twocolumnblackbox}
\storychapter{Very Long Story Chapter}{Author}{example-image-a}{example-image-b}
\lipsum
\storypar
\lipsum
\storypar
\lipsum
\storypar
\lipsum
\chapter{Images}
\lipsum
\section{Two Column Image}
\lipsum
\twocolumnimage{example-image-c}
\lipsum
\section{One Column Image}
\lipsum
\columnimage{Shadowrun_Cover_1530x1980px.jpg}
\lipsum
\lipsum
\lipsum
\lipsum
\lipsum
\storychapter{Unter Dem Kreuz Hervor}{Christian Meyer}{Shadowrun_Cover_1530x1980px.jpg}{Shadowrun_Cover_1530x1980px.jpg}
Jakob Müller ließ seine Hände über den Weizen streichen, während er den Kopf hob und den Nieselregen auf seinem Gesicht genoss. Er atmete tief ein und erfreute sich an dem erdigen Geruch von feuchtem Ackerboden. Die Augen wieder geöffnet, ließ er seinen Blick in die Ferne, über die unendliche Fläche des Weizens, gleiten.
"Überprüfung einer Fehlermeldung an Eingangstür C-15 erforderlich. Auftrag bestätigen: ja – nein?"
Das Pop-up riss ihn aus der Entspannung.
"Techniker Müller, ID 1765 bestätigt." Seufzend verließ er die VR-Darstellung des Hosts und ging seinen Werkzeugkasten holen.
So eine Agraranlage betreibt sich eben auch in Westphalen nicht allein durch Gottes Gnade.

Das Diagnoseprogramm an Tür C-15 meldete normale Parameter, die Verbindung zum Host zeigte bei der Prüfung ebenfalls keine Auffälligkeiten. Jakob schraubte das Gehäuse wieder zu und verstaute sein Werkzeug. Seufzend machte er sich auf den Rückweg zum Bereitschaftsraum. In der Nähe des Wartungsschachtes glaubte er merkwürdige Geräusche zu hören und blieb stehen. Jakob lauschte, und tatsächlich kamen aus dem Zugangsraum zum Wartungsschacht Stimmen.
"Jetzt mach hin, ich will hier langsam raus!", hörte er aus dem Raum. Eigentlich sollte um diese Uhrzeit niemand in dieser Ecke des Gebäudes sein. Vorsichtig lugte er um die Ecke. Vier Personen: ein Ork, ein Zwerg, zwei Menschen. Dunkel gekleidet und bewaffnet. Einer der Menschen sah aus, als könnte es sich dabei um eine Frau handeln. Gut, dass er noch sein Kommlink an seine Datenbuchse angeschlossen hatte. Seine Finger wurden vor Angst und Aufregung zittrig. Das waren bestimmt Shadowrunner.

Schnell wählte er die Nummer des Sicherheitsdienstes.
"Guten Tag, Werkssicherheit Agraranlage Greven. Mein Name ist Gert Heuwen, was kann ich für Sie tun?“
"Da sind Shadowrunner …“, haspelte Jakob über sein DNI hervor.
"Bitte identifizieren Sie sich und sagen mir, wo Sie sind“, antwortete der Sicherheitsangestellte.
"Äh, ja … Jakob Müller, ID 1765. Ich befinde mich an Zugang W4 zum Wartungsschacht. Kommen Sie schnell!“ Jakobs Gedanken überschlugen sich, als er dem Sicherheitsmann die benötigten Informationen zukommen ließ.
"Und was genau haben Sie gesehen?"
"Vier Personen, bewaffnet, aktuell wollen sie wohl den Wartungsschacht öffnen."
"Bringen Sie sich in Sicherheit, wir sind unterwegs", waren die letzten Worte, bevor der Sicherheitsmann auflegte.

Jakob lehnte sich neben der Ecke an die Wand und versuchte sich zu beruhigen. Er konnte die Runner nebenan hören.
"Dreck, der Alarm ist ausgelöst!", fluchte eine männliche Stimme.
"Ich dachte, du hast den umgeleitet", grummelte eine tiefe Stimme.
"In der Sicherheitszentrale eingehende und zur Konzernzentrale rausgehende, ja. Keine Ahnung, wo der jetzt herkommt", antwortete die erste Stimme.
"Ist doch jetzt auch egal, lasst uns hier schnell fertig werden, bevor sie uns finden!", fauchte eine weibliche Stimme.
Jakob traute seinen Ohren nicht. Das war doch …
"Sabrina?" Er schaute um die Ecke und rieb sich die Augen.
Da stand sie tatsächlich. Er hatte sie seit über einem Jahr nicht mehr gesehen.

Die Runner zuckten herum und rissen ihre Waffen aus den Holstern. Jakob schluckte, als er in die Läufe schaute. Vorsichtig hob er seine leeren Hände.
"Jakob?" Sabrinas Stimme klang wie früher. Sie ließ ihre Waffe sinken und bedeutete den anderen, es ebenfalls zu tun.
"Was in Herrgottsnamen ist denn das jetzt?", grummelte der Zwerg.
Sabrina funkelte ihn an. "Das ist mein Bruder. Und jetzt nimm die Waffe runter. Copperline, mach den blöden Schacht auf, bevor die Sicherheit uns findet und hier um uns herumsteht." Das Fauchen in der Stimme kannte Jakob noch gut.
"Äh, ich fürchte, sie wissen, wo ihr seid", flüsterte Jakob.
"Du hast den Alarm ausgelöst?", fragte der Ork.
Er kniff die Augen zu. "Ja …", gab er leise zu.

"Sketch, Vorschläge für Deckung? Kurzer, bereite einen Geist vor und plane für magische Opposition. Elektronenjockey, mach hin mit dem Schacht …"
Die Anweisungen waren weiterhin gebrummelt, aber kurz und präzise. Die Waffen klickten und schienen ihn nicht zu erschießen.
"Hey, Drohne, wenn du keine dummen Fragen beantworten willst, solltest du entweder schnell verschwinden oder wenigstens in Deckung gehen."
Jakob öffnete vorsichtig die Augen. Die Waffen waren nicht mehr auf ihn gerichtet. Der Mensch hatte sich wieder dem Wartungsschacht zugewandt, Sabrina blickte sich im Bereitschaftsraum um und ging gerade auf den Snackautomaten zu.
Der Zwerg lehnte sich in die Ecke und schien sich auf etwas Unsichtbares zu konzentrieren. So sah Magie aus? Bei Karl Kombatmage war das aber spektakulärer. Der Ork musterte ihn weiter.

Jakob hörte hinter sich schwere Stiefel den Gang entlanglaufen.
"Sie kommen!", stieß er hervor. Er warf noch einen schnellen Blick zu Sabrina, als er sich zurückziehen wollte. Sie trug gerade den Snackautomaten. Er schaute noch mal hin, nur um sicherzugehen.
"Was … was machst du da?", fragte er ungläubig.
"Aus dem Weg, ich schaffe Deckung. Verschwinde jetzt lieber", antwortete sie schroff.

Jakob brachte sich in Sicherheit. Aber sein Geist versuchte immer noch, das Gesehene zu verarbeiten. Da begannen die Schüsse. Und die Schreie.
Er wand sich in einer Ecke und presste sich die Hände auf die Ohren. Durch die Gänge hallte der Lärm der Schießerei trotzdem furchterregend an seine Ohren.

Es schien kein Ende zu nehmen. Auf einmal spürte er, wie ihn jemand berührte. Er zuckte zusammen und schrie kurz auf.
"Jakob, reiß dich zusammen!", fauchte Sabrina ihn an. "Wir brauchen deine Hilfe."
Jakob blickte verwirrt. "Was? Ist es schon vorbei?"
"Ja, und wir brauchen deine Hilfe." Sie klang schon fast flehend. "Copperline hat’s erwischt. Wir brauchen einen Hacker, der uns den Schacht öffnet." Ihre Stimme wurde weicher. Es klang verzweifelt. "Sonst schaffen wir es nicht zum Fluchtfahrzeug, und anders kommen wir hier nicht weg. Bitte, Jakob, du musst mir helfen." Die letzten Worte schluchzte sie fast.
\storypar
Das war vor sechs Monaten gewesen. Jakob war unter dem Kreuz Westphalens hervorgekrochen und in den Rhein-Ruhr-Megaplex gegangen. Er schüttelte den Kopf. Nein, nicht Jakob. Wavelength. Er war der neue Decker in Sabrinas Team. Das stimmte auch nicht. Hier hieß sie Sketch.
"Hey, Wavelength, was ist mit der Tür?", klang Sketchs Stimme in seinem Kopf. Er blickte kurz hinüber.
"Gleich bereit. Einen Moment noch", antwortete Wavelength. Er holte tief Luft und stürzte sich in die digitalen Fluten, um seinem Team die Tür zu öffnen. 

\end{document}